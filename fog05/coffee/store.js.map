{
  "version": 3,
  "file": "store.js",
  "sourceRoot": "",
  "sources": [
    "store.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "# This file contain the implementation of a proxy Store for interacting\n# with fog05. Through this API any JS-based runtime can interact with the\n# distributed store used by fog05. As such it can access the full power of\n# fog05\n\nroot = this\nz_ = coffez\nfog05 = {}\n\nif (typeof exports isnt 'undefined')\n  if (typeof module isnt 'undefined' and module.exports)\n    exports = module.exports = fog05\n  exports.fog05 = fog05\nelse\n  root.fog05 = fog05\n\nfog05.VERSION = \"0.1.0\"\n\n# Commands\n\nclass OK\n  constructor: (@cid, @sid, @rest) ->\n  show: () ->\n    args = @rest.reduce((a, x) -> a + \" \" + x)\n    \"OK #{@cid} #{@sid} #{@args}\"\n\nclass NOK\n  constructor: (@cid, @sid) ->\n  show: () ->\n    \"NOK #{@cid} #{@sid}\"\n\nclass Create\n  constructor: (@sid, @root, @home, @cache_size) ->\n  show: () ->\n    \"create #{@sid} #{@root} #{@home} #{@cache_size}\"\n\nclass Put\n  constructor: (@sid, @uri, @value) ->\n  show: () ->\n    \"put #{@sid} #{@uri} #{@value}\"\n\nclass Get\n  constructor: (@sid, @uri) ->\n  show: () ->\n    \"get #{@sid} #{@uri}\"\n\nclass Observe\n  constructor: (@sid, @cookie, @uri) ->\n  show: () ->\n    \"observe #{@sid} #{@uri}\"\n\nclass Notify\n  constructor: (@sid, @cookie, @uri, @value) ->\n  show: () ->\n    \"notify #{@sid} #{@uri} #{@value}\"\n\nclass Value\n  constructor: (@sid, @key, @value) ->\n  show: () ->\n    \"value #{@sid} #{@key} #{@value}\"\n\nparseOK: (ts) ->\n  if ts.length > 2\n    z_.Some(new OK(ts[1], ts[2], ts[3..]))\n  else\n    z_.None\n\nparseNOK: (ts) ->\n  if ts.length > 2\n    z_.Some(new NOK(ts[1], ts[2]))\n  else\n    z_.None\n\nparseNotify: (ts) ->\n  if ts.length > 4\n    z_.Some(new Notify(ts[1], ts[2], ts[3], tr[4]))\n  else\n    z_.None\n\nparseValue: (ts) ->\n  if ts.length == 3\n    new Value(ts[1], ts[2], z_.None)\n  else if ts.length > 3\n    z_.Some(new Value(ts[1], ts[2], z_.Some(ts[3])))\n  else\n    z_.None\n\n\nparse: (cmd) ->\n  tokens = (x for x in cmd.split(' ') x != '')\n  if tokens.length == 0\n    z_.None\n  else\n    t = tokens[0]\n    if t == 'OK'\n      parseOK(tokens)\n    else if t == 'NOK'\n      parseNOK(tokens)\n    else if t == 'notify'\n      parseNotify(tokens)\n    else if t == 'value'\n      parseValue(tokens)\n\n    else\n      z_.None      \n\n# The `Runtime` maintains the connection with the server, re-establish the connection if dropped and mediates\n# the `DataReader` and `DataWriter` communication.\nclass Runtime\n  # Creates a new fog05 runtime\n  constructor: (@url) ->\n    @onclose = (evt) ->\n    @onconnect = () ->\n    @ondisconnect = (evt) ->\n    @connected = false\n    @closed = true\n    @cookieId = 0\n    @pendingWebSock = z_.None\n    @webSock = z_.None\n    @storeHandlersMap = {}\n\n\n  generateEntityId: () ->\n    id = @cookieId\n    @cookieId += 1\n    id\n\n  # Establish a connection with the dscript.play server\n  connect: () =>\n    if @connected is false\n      console.log(\"Connecting to: #{url}\")\n      @pendingWebSock = new z_.Some(new WebSocket(url))\n\n      @pendingWebSock.map (\n        (s) =>\n          s.onopen = () =>\n            console.log('Connected to: ' + @uri)\n            @webSock = @pendingWebSock\n            @connected = true\n            # We may need to re-establish dropped data connection, if this connection is following\n            # a disconnection.\n            @onconnect()\n      )\n\n      @pendingWebSock.map (\n        (s) => s.onclose =\n          (evt) =>\n            console.log(\"The server at #{@uri} seems to have dropped the connection.\")\n            @connected = false\n            @webSock.close()\n            @closed = true\n            @webSock = z_.None\n            @ondisconnect(evt)\n      )\n\n\n      @pendingWebSock.map (\n        (s) =>\n          s.onmessage = (msg) =>\n            this.handleMessage(msg)\n      )\n    else\n      console.log(\"Warning: Trying to connect an already connected Runtime\")\n\n\n  # Disconnects, withouth closing, a `Runtime`. Notice that there is a big difference between disconnecting and\n  # closing a `Runtime`. The a disconnected `Runtime` can be reconnected and retains state across\n  # connection/disconnections. On the other hand, once closed a `Runtime` clears up all current state.\n  disconnect: () =>\n    @connected = false\n    @webSock.map(\n      (s) -> s.close()\n    )\n    @ondisconnect()\n\n\n  # Close the fog05 runtime and as a consequence all the `DataReaders` and `DataWriters` that belong to this runtime.\n  close: () =>\n    @webSock.map (\n      (s) =>\n        s.close()\n        this.onclose()\n    )\n\n  isConnected: () => @connected\n\n  isClosed: () => @closed\n\n\n  handleMessage: (s) =>\n    msg = s.data\n    console.log('received'+ msg)\n    cmd = parse(msg)\n    handlers = @storeHandlersMap\n    cmd.map ( (c) ->\n      h = handlers[c.cid]\n      if h? == true\n        h(c)\n    )\n\n\n\n  send: (msg) ->\n    @webSock.map(\n      (s) -> s.send(msg)\n    )\n\n  register: (sid, handlers) ->\n    @storeHandlersMap[sid] = handlers\n\n\nroot.fog05.Runtime = Runtime\n\nclass Store\n  constructor: (@runtime, @sid, @home, @root, @cache_size) ->\n    @getTable = {}\n    @obsTable = {}\n    @handlers = {\n      OK: (cmd) -> self.handleOK(cmd),\n      NOK: (cmd) -> self.handleNOK(cmd)\n      notify: (cmd) -> self.handleNotify(cmd)\n      value: (cmd) -> self.handleValue(cmd)\n    }\n    runtime.register(@sid, @handlers)\n    cmd = new Create(@sid, @home, @root, @cache_size)\n    @runtime.send(cmd.show())\n\n  put: (key, value)  ->\n    cmd = new Put(@sid, @key, @value)\n    @runtime.send(cmd.show())\n\n  get: (fun) -> (key) ->\n    @getTable[key] = fun\n    cmd = new Get(@sid, key)\n    @runtime.send(cmd.show())\n\n  observe: (key, cookie, fun) ->\n    @obsTable[cookie] = fun\n    cmd = new Observe(@cid, @cookie, @uri)\n    @runtime.send(cmd.show())\n\n  handleOK: (cmd) ->\n    console.log('Store Handling OK')\n\n  handleValue: (cmd) ->\n      fun = @getTable[cmd.key]\n      if fun? == true\n        fun(cmd.key, cmd.value)\n\n  handleNotify: (cmd) ->\n    console.log('Store Handling Notify')\n    fun = @obsTable[cmd.cookie]\n    if fun? == true\n      fun(cmd.key. cmd.value)\n\n  handleNOK: (cmd) ->\n    console.log('Store Handling NOK')\n\n"
  ]
}